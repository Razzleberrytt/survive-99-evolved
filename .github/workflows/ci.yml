name: ci
on:
  push:
    branches: [ "main" ]
  pull_request: {}
permissions:
  contents: read
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Aftman
        run: |
          curl -fsSL https://raw.githubusercontent.com/LPGhatguy/aftman/main/install.sh | bash
          echo "$HOME/.aftman/bin" >> $GITHUB_PATH

      - name: Install toolchain
        run: |
          aftman install
          echo "Aftman tools:" && ls -l "$HOME/.aftman/bin" || true

      - name: Wally install
        run: |
          if command -v wally >/dev/null; then
            wally install
          else
            echo "wally not found via aftman; ensure aftman.toml pins wally." && exit 1
          fi

      - name: Lint & Format (non-blocking for now)
        run: |
          if command -v stylua >/dev/null; then stylua --check . || true; fi
          if command -v selene >/dev/null; then selene . || true; fi

      - name: Run tests (best-effort)
        run: |
          bash scripts/run-tests.sh || true

      - name: Build rbxm
        run: |
          if command -v rojo >/dev/null; then
            rojo build --output Survive99.rbxm default.project.json
          else
            echo "rojo not found via aftman; ensure aftman.toml pins rojo." && exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Survive99-build
          path: Survive99.rbxm
